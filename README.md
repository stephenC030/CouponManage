# CouponManage

This is a Proof of Concept repo for managing coupon or reward code using Microservices.

This project is built based on Spring Boot and Spring Cloud. 

Based on the concept of Microservices, I split the whole service into three main modules: Template, Distribution and Settlement.

# Template Module

Template module is mainly for operation staff who is responsible for creating multiple forms of coupons. They can specify the type, name, logo, categories, 
settlement rules of the coupon.

For every template created by operation staff, a coupon code will be generated by a service and stored into Redis. There are two purposes:

1. A simple solution for Consistency between Redis Cache and Database. Every coupon that is used, will be put into a HashSet to ensure the amount is matched.

2. Let a template instance generate coupon code to put into Redis, utilizing the single-thread property of Redis to solve the problem of concurrency and over-distributing coupons.

For expired coupons, we use two policies to deal with it:

1. A scheduled check on expired coupons.

2. When the other services is trying to use the coupon, check the expiration to avoid delayed check due to policy 1.

# Distribution Module

There are four core functions of Distribution service:

1. Look up the coupon record of user.

  i. Three status of coupon: Usable, Used, Expired(which was never used, but passed the expiration date).

  ii.  All the coupon info is stored in Redis other than MySQL, for improving the response speed.

  iii. Asynchronous operations: use Kafka to handle the operations which take long time, like changing status of expiration coupons in MySQL.
  
2. Look up available coupon template according to id.
  
  i. Utilize Feign + Hystrix to apply a circuit break fallback policy, to avoid collapse of the whole system.
  
  ii. There maybe limitation of number of coupons for each user. So make an additional judge based on existing coupons of current user.
  
3. User adopting coupon
  If user is eligible for adopting the coupon, write the info to MySQL and Redis.
  
4. Settlement
  i. Validate the current coupon is legal(the coupon belongs to user and is usable).
  
  ii. Invoking settlment service for calculating the final price after applying the coupon.
  
# Settlement Module

Calculate the final price after applying the coupons.

There could be different combinations of Coupons. Like $20 off $100, in addition to 30% off.

This service will never be exposed to user. It will only be accessible to Distribution Service by Feign.

This service will calculate the price according to arguments passed from other services, with combination, settlement rules and categories.

# Zuul Gateway and Registration server

The request will be proxy and directed by Zuul Gateway. All the services and registered in Eureka Server. 
